# 第6章应用层  

## 【考纲内容】  

（一）网络应用模型客户/服务器模型；P2P模型  

（二）域名系统（DNS）  

层次域名空间：域名服务器：域名解析过程  

（三）文件传输协议（FTP）FTP的工作原理：控制连接与数据连接  

（四）电子邮件（E-mail）电子邮件系统的组成结构；电子邮件格式与MIME；SMTP与POP3  

## 【复习提示】  

本章内容既可以以选择题的形式考查，又可以结合其他章节的内容出综合题。所以牢固掌握本章的几个典型应用层协议是关键。我们生活中的很多网络应用都是建立在这些协议的基础上的，因此在学习时要注意联系实际，提高学习的兴趣，才会获得更好的学习效果。  

# 网络应用模型  

## 客户/服务器模型  

命题追踪C/S模型和P2P模型的特点（2019）  

在客户/服务器（ClientServer，C/S）模型中，有一个总是打开的主机称为服务器，它服务于许多来自其他称为客户机的主机请求。其工作流程如下：  

1）服务器处于接收请求的状态。  

2）客户机发出服务请求，并等待接收结果。  

3）服务器收到请求后，分析请求，进行必要的处理，得到结果并发送给客户机。  

服务器上运行着专门用来提供某种服务的程序，可同时处理多个远程或本地客户的请求。客户程序必须知道服务器程序的地址。服务器启动后就一直不断地运行着，被动等待并接收来自各地客户的请求。因此，服务器程序不需要知道客户程序的地址。  

客户/服务器模型最主要的特征是：客户是服务请求方，服务器是服务提供方。如Web应用程序，其中总是打开的Web服务器服务于运行在客户机上的浏览器的请求。当Web服务器接收到来自客户机对某对象的请求时，它向该客户机发送所请求的对象以做出响应。使用客户/服务器模型的常见应用包括Web、文件传输协议（FTP）、远程登录和电子邮件等。  
客户/服务器模型的主要特点还有：  

1）网络中各计算机的地位不平等，服务器可通过对用户权限的限制来达到管理客户机的目的。整个网络的管理工作由少数服务器担当，因此网络的管理非常集中和方便。2）客户机相互之间不直接通信。例如，在Web应用中两个浏览器并不直接通信。3）可扩展性不佳。受服务器硬件和网络带宽的限制，服务器支持的客户机数有限。  

## P2P模型  

在C/S模型中（图6.1），服务器性能的好坏决定了整个系统的性能，当大量用户请求服务时，服务器就必然成为系统的瓶颈。P2P模型（见图6.2）的思想是整个网络中的传输内容不再被保存在中心服务器上，每个结点都同时具有下载、上传的功能，其权利和义务都是大体对等的。  

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/0968413e5bed6d57bfeff2b949e4c6ede48faed1adb20a5457f23dced3514fd4.jpg)  
图6.1C/S模型  

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/056de45a9156710326d6d90dbab1f59c67aa4d467d7068d514a39ca0ff6589da.jpg)  
图6.2P2P模型  

在P2P模型中，各计算机没有固定的客户和服务器划分。相反，任意一对计算机一一称为对等方（Peer），直接相互通信。实际上，P2P模型从本质上来看仍然使用客户/服务器模型，每个结点既作为客户访问其他结点的资源，又作为服务器提供资源给其他结点访问。  

与C/S模型相比，P2P模型的优点主要体现如下：1）减轻了服务器的计算压力，消除了对某个服务器的完全依赖，可以将任务分配到各个结点上，因此大大提高了系统效率和资源利用率。2）多个客户机之间可以直接共享文档。3）可扩展性好，传统服务器有响应和带宽的限制，因此只能接受一定数量的请求。4）网络健壮性强，单个结点的失效不会影响其他部分的结点。  

P2P模型也有缺点。在获取服务的同时，还要给其他结点提供服务，因此会占用较多的内存，影响整机速度。例如，经常进行P2P下载还会对硬盘造成较大的损伤。据某互联网调研机构统计，当前P2P程序已占互联网 $50\%{\sim}90\%$ 的流量，使网络变得非常拥塞，因此各大ISP（互联网服务提供商，如电信、网通等）通常都对P2P应用持反对态度。  

 

# 域名系统(DNS)  

>#### pro：DNS向下依次使用的协议（2018、2021）  

域名系统（DomainNameSystem，DNS）是因特网使用的命名系统，用来把便于人们记忆的具有特定含义的主机名（如www.cskaoyan.com）转换为便于机器处理的IP地址。相对于IP地址，人们更喜欢使用具有特定含义的字符串来标识因特网上的计算机。值得注意的是，DNS系统采用客户/服务器模型，其协议运行在UDP之上，使用53号端口。  

从概念上可将DNS分为三部分：层次域名空间、域名服务器和解析器。  

## 层次域名空间  

因特网采用层次树状结构的命名方法。采用这种命名方法，任何一个连接到因特网的主机或路由器，都有一个唯一的层次结构名称，即域名（DomainName）。域（Domain）是名字空间中一个可被管理的划分。域可以划分为子域，而子域还可以继续划分为子域的子域，这样就形成了顶级域、二级域、三级域等。每个域名都由标号序列组成，而各标号之间用点（“.”）隔开。一个典型的例子如图6.3所示，它是王道论坛用于提供WWW服务的服务器的域名，它由三个标号组成，其中标号com是顶级域名，标号cskaoyan是二级域名，标号www是三级域名。  

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/335d7e57f36898e0a60c2df2cb3fd7fdafea1eee6aa0d4604bcebd67d4068da1.jpg)  
图6.3一个域名的例子  

关于域名中的标号有以下几点需要注意：1）标号中的英文不区分大小写。  
2）标号中除连字符（-）外不能使用其他的标点符号。3）每个标号不超过63个字符，多标号组成的完整域名最长不超过255个字符。4）级别最低的域名写在最左边，级别最高的顶级域名写在最右边。顶级域名（Top Level Domain，TLD）分为如下三大类  

1）国家（地区）顶级域名（nTLD）。国家和某些地区的域名，如“.cn”表示中国，“us”表示美国，“uk”表示英国。2）通用顶级域名（gTLD）。常见的有“.com”（公司）、“net”（网络服务机构）、“org”（非营利性组织）、“edu”（教育机构）、和“gov”（国家或政府部门）等。  

3）基础结构域名（arpa）。用于反向域名解析，即IP地址反向解析为域名。  

图6.4展示了域名空间的树状结构。  

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/c7c571a79927f4b59ecf1e91a76adf8317ac05d76b12b5a344e3d21ebb103c82.jpg)  
图6.4域名空间的树状结构  

在域名系统中，各级域名由其上一级的域名管理机构管理，顶级域名由因特网名称与数字地址分配机构（ICANN）管理。国家顶级域名下注册的二级域名均由该国家自行确定，每个组织都可以将它的域再分成一定数目的子域，并将这些子域委托给其他组织去管理。例如，管理cn域的中国将edu.cn子域授权给中国教育和科研计算机网（CERNET）来管理。  

## 域名服务器  

域名到TP地址的解析是由运行在域名服务器上的程序完成的，一个服务器所负责管辖的（或有权限的）范围称为区（小于或等于“域”），一个区中的所有结点必须是能够连通的，每个区设置相应的权限域名服务器，用来保存该区中的所有主机的域名到DP地址的映射。每个域名服务器不但能够进行一些域名到ITP地址的解析，而且还必须具有连向其他域名服务器的信息。当自己不能进行域名到IP地址的转换时，能够知道到什么地方去找其他域名服务器。  

DNS使用了大量的域名服务器，它们以层次方式组织。没有一台域名服务器具有因特网上所有主机的映射，相反，该映射分布在所有的域名服务器上。有4种类型的域名服务器。  

### 根域名服务器  

根域名服务器是最高层次的域名服务器，所有的根域名服务器都知道所有的顶级域名服务器的域名和IP地址。根域名服务器是最重要的域名服务器，不管是哪个本地域名服务器，要对因特网上任何一个域名进行解析，只要自己无法解析，就首先要求助于根域名服务器。因特网上有13个根域名服务器，尽管我们将这13个根域名服务器中的每一个都视为单个服务器，但每个“服务器”实际上是究余服务器的集群，以提供安全性和可靠性。需要注意的是，根域名服务器用来管辖顶级域（如.com），通常它并不直接把待查询的域名直接转换成IP地址，而是告诉本地域名服务器下一步应当找哪个顶级域名服务器进行查询。  
### 顶级域名服务器  

这些域名服务器负责管理在该顶级域名服务器注册的所有二级域名。收到DNS查询请求时，就给出相应的回答（可能是最后的结果，也可能是下一步应当查找的域名服务器的IP地址）。  

### 权限域名服务器（授权域名服务器）  

每台主机都必须在权限域名服务器处登记。为了更加可靠地工作，一台主机最好至少有两个权限域名服务器。实际上，许多域名服务器都同时充当本地域名服务器和权限域名服务器。权限域名服务器总能将其管辖的主机名转换为该主机的IP地址。  

### 本地域名服务器  

本地域名服务器对域名系统非常重要。每个因特网服务提供者（ISP），或一所大学，甚至一所大学中的各个系，都可以拥有一个本地域名服务器。当一台主机发出DNIS查询请求时，这个查询请求报文就发送给该主机的本地域名服务器。事实上，我们在Windows系统中配置“本地连接”时，就需要填写DNS地址，这个地址就是本地DNS（域名服务器）的地址。  

DNS的层次结构如图6.5所示。  

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/5629d8bb8fb5177ee3e9a1ab880774ec6a90aeab599acde76f7da73da3ff2f16.jpg)  
图6.5DNS的层次结构  

## 域名解析过程  

>#### pro：命题追踪DNS协议的作用（2021)  

域名解析是指把域名转化为IP地址的过程。当客户端需要域名解析时，通过本机的DNS客户端构造一个DNS请求报文，以UDP数据报方式发往本地域名服务器。  

域名解析有两种方式：递归查询和选代查询。
#### （1）主机向本地域名服务器的查询都采用递归查询  

递归查询是指若主机所询问的本地域名服务器不知道被查询域名的IP地址，则本地域名服务器就以DINS客户的身份，向根域名服务器继续发出查询请求报文（即替该主机继续查询），而不是让该主机自己进行下一步的查询。两种查询方式的这一步是相同的。  

#### （2）本地域名服务器向其他域名服务器采用递归查询或选代查询  
>#### pro：递归查询DNS的工作原理（2010）  

递归查询的过程如图6.6（a所示，本地域名服务器只需向根域名服务器查询一次，后面的几次查询都是递归地在其他几个域名服务器之间进行的［步骤 $\scriptstyle(\mathbf{\mathcal{B}}\sim\left(\mathbf{\mathcal{C}}\right)$ ]。在步骤 $\circleddash$ 中，本地域名服务器从根域名服务器得到了所需的ⅡP地址，最后在步骤 $^\mathrm{\textregistered}$ 中，本地域名服务器把查询结果告诉发起查询的主机。因为该方法给根域名服务器造成的负载过大，所以实际中几乎不使用。  

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/2663a99a9e96d72925ec8df3f3c96270b6c7942f0010e486c7694ed8830a3713.jpg)  
图6.6两种域名解析方式工作原理  

>#### pro：选代查询DNS的工作原理（2016、2020）  

本地域名服务器向根域名服务器的查询通常是采用送代查询。当根域名服务器收到本地域名服务器发出的选代查询请求报文时，要么给出所要查询的IⅡP地址，要么告诉本地域名服务器：“你下一步应当向哪个顶级域名服务器进行查询”。然后让本地域名服务器进行后续的查询（而不替本地域名服务器进行后续的查询），如图6.6(b)所示。同样，顶级域名服务器收到查询报文后，要么给出所要查询的IP地址，要么告诉本地域名服务器下一步应当向哪个权限域名服务器查询。最后，知道了所要解析的域名的IP地址后，把这个结果返回给发起查询的主机。  

下面举例说明域名解析的过程。假定某客户机想获知域名为y.abc.com主机的IP地址，域名解析的过程（最多需要使用8个UDP报文：4个查询报文和4个回答报文）如下：  

$\textcircled{\scriptsize{1}}$ 客户机向其本地域名服务器发出DNS请求报文（递归查询）。 $\circledcirc$ 本地域名服务器收到请求后，查询本地缓存，若没有该记录，则以DINS客户的身份向根域名服务器发出解析请求报文（迭代查询）。 $\textcircled{3}$ 根域名服务器收到请求后，判断该域名属于.com域，将对应的顶级域名服务器dns.com的IP地址返回给本地域名服务器。 $\textcircled{4}$ 本地域名服务器向顶级域名服务器dns.com发出解析请求报文（迭代查询）。 $\circledast$ 顶级域名服务器dns.com收到请求后，判断该域名属于abc.com域，因此将对应的权限域名服务器dns.abc.com的IP地址返回给本地域名服务器。 $^\mathrm{\textregistered}$ 本地域名服务器向权限域名服务器dns.abc.com发起解析请求报文（选代查询）。 $\circleddash$ 权限域名服务器dns.abc.com收到请求后，将查询结果返回给本地域名服务器。 $\circledast$ 本地域名服务器将查询结果保存到本地缓存，同时返回给客户机。  

为了提高DINS的查询效率，并减少因特网上的DNS查询报文数量，在域名服务器中广泛地使用了高速缓存，用来缓存最近查询过的域名的相关映射信息。这样，当另一个相同的域名查询到达该DINIS服务器时，该服务器就能直接提供所要求的IP地址。因为主机名和IP地址之间的映射不是永久的，所以DNS服务器将在一段时间后去弃高速缓存中的信息。在主机中同样也很需要高速缓存，许多主机在启动时从本地域名服务器下载域名和地址的全部数据库，维护存放自己最近使用的域名的高速缓存，并且只在从缓存中找不到域名时才使用域名服务器。  

# 文件传输协议(FTP)  

## FTP的工作原理  

文件传输协议（FileTransferProtocol，FTP）是因特网上使用得最广泛的文件传输协议。FTP提供交互式的访问，充许客户指明文件的类型与格式，并充许文件具有存取权限。它屏蔽了各计算机系统的细节，因而适合于在异构网络中的任意计算机之间传送文件。  
FTP提供以下功能：  

$\textcircled{\scriptsize{1}}$ 提供不同种类主机系统（硬、软件体系等都可以不同）之间的文件传输能力。 $\circledcirc$ 以用户权限管理的方式提供用户对远程FTP服务器上的文件管理能力。 $\textcircled{3}$ 以匿名FTP的方式提供公用文件共享的能力。  

>#### pro：FTP在传输层所使用的协议（2009、2018）  

FTP采用客户/服务器的工作方式，使用TCP可靠的传输服务。一个FTP服务器进程可同时为多个客户进程提供服务。FTP的服务器进程由两大部分组成：一个主进程，负责接收新的请求：另外有若干从属进程，负责处理单个请求。其工作步骤如下：  

$\textcircled{\scriptsize{1}}$ 打开熟知端口21（控制端口），使客户进程能够连接上。  

$\circledcirc$ 等待客户进程发连接请求。 $\textcircled{3}$ 启动从属进程处理客户进程发来的请求。从属进程对客户进程的请求处理完毕后即终止。  

$\textcircled{4}$ 回到等待状态，继续接收其他客户进程的请求。主进程与从属进程是并发执行的。  

FTP服务器必须在整个会话期间保留用户的状态信息。特别是服务器必须把指定的用户账户与控制连接联系起来，服务器必须追踪用户在远程目录树上的当前位置。  

## 控制连接与数据连接  

>#### pro：控制连接和数据连接的特点（2017、2023）  

FTP在工作时使用两个并行的TCP连接（见图6.7）：一个是控制连接（服务器端口号21），一个是数据连接（服务器端口号20）。使用两个不同的端口号可以使协议更容易实现。  

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/c1f0808dc3aeb3e8fa2e341b8a51d60ebf4df40ec50c263cab6b38816315d50f.jpg)  
图6.7控制连接和数据连接  

### 控制连接  

>#### pro：控制连接的作用（2009）  

服务器监听21号端口，等待客户连接，建立在这个端口上的连接称为控制连接，用来传输控制信息（如连接请求、传送请求等）。FTP客户发出的传送请求，通过控制连接发送给服务器端的控制进程，但控制连接并不用来传送文件。在传输文件时还可以使用控制连接（如客户在传输中途发一个中止传输的命令），因此控制连接在整个会话期间一直保持打开状态。  

### 数据连接  

服务器端的控制进程在接收到FTP客户发送来的文件传输请求后，就创建“数据传送进程”和“数据连接”。数据连接用来连接客户端和服务器端的数据传送进程，数据传送进程实际完成文件的传送，在传送完毕后关闭“数据传送连接”并结束运行。  

数据连接有两种传输模式：主动模式PORT和被动模式PASV。PORT模式的工作原理：客户端连接到服务器的21端口，登录成功后要读取数据时，客户端随机开放一个端口，并发送命令告知服务器，服务器收到PORT命令和端口号后，通过20端口和客户端开放的端口连接，发送数据。PASV模式的不同点是，客户端要读取数据时，发送PASV命令到服务器，服务器在本地随机开放一个端口，并告知客户端，客户端再连接到服务器开放的端口进行数据传输。可见，是用PORT模式还是PASV模式，选择权在客户端。简单概括为，主动模式传送数据是“服务器”连接到“客户端”的端口；被动模式传送数据是“客户端”连接到“服务器”的端口。  
>##### attention:  

很多教材并未介绍这两种模式，如无特别说明可默认为采用主动模式。  

因为FTP使用了一个分离的控制连接，所以也称FTP的控制信息是带外（Out-ofband）传送的。使用FTP时，要修改服务器上的文件，就需要先将此文件传送到本地主机，然后将修改后的文件副本传送到原服务器，来回传送耗费很多时间。网络文件系统（NFS）采用另一种思路，它允许进程打开一个远程文件，并能在该文件的某个特定位置开始读写数据。这样，NFS可使用户只复制一个大文件中的一个很小的片段，而不需要复制整个大文件。  

 
# 电子邮件  

## 电子邮件系统的组成结构  

自从有了因特网，电子邮件就在因特网上流行起来。电子邮件是一种异步通信方式，通信时不需要双方同时在场。电子邮件把邮件发送到收件人使用的邮件服务器，并放在其中的收件人邮箱中，收件人可以随时上网到自已使用的邮件服务器进行读取。  

一个电子邮件系统应具有图6.8所示的三个最主要的组成构件，即用户代理（UserAgent）、邮件服务器和电子邮件使用的协议，如SMTP、POP3（或IMAP）等。  
![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/dfcc3f07d050e1a4bd109677dfc892e5090689da8a858b59b160fa23ab313e71.jpg)  
图6.8电子邮件系统最主要的组成构件  

用户代理（UA）：用户与电子邮件系统的接口。用户代理向用户提供一个很友好的接口来发送和接收邮件，用户代理至少应当具有撰写、显示和邮件处理的功能。通常情况下，用户代理就是一个运行在PC上的程序（电子邮件客户端软件），常见的有Outlook和Foxmail等。  

邮件服务器：它的功能是发送和接收邮件，同时还要向发件人报告邮件传送的情况（已交付、被拒绝、丢失等）。邮件服务器以客户/服务器模式工作，但它必须能够同时充当客户和服务器。例如，当邮件服务器A向邮件服务器B发送邮件时，A就作为SMTP客户，而B是SMTP服务器；反之，当B向A发送邮件时，B就是SMTP客户，而A就是SMTP服务器。  

>#### pro：邮件发送协议和读取协议的应用（2012）  

邮件发送协议和读取协议：邮件发送协议用于用户代理向邮件服务器发送邮件或在邮件服务器之间发送邮件，如SMTP；邮件读取协议用于用户代理从邮件服务器读取邮件，如POP3。注意，SMTP用的是“推”（Push）的通信方式，即用户代理向邮件服务器发送邮件及在邮件服务器之间发送邮件时，SMTP客户将邮件“推”送到SMTP服务器。而POP3用的是“拉”（PulI）的通信方式，即用户读取邮件时，用户代理向邮件服务器发出请求，“拉”取用户邮箱中的邮件。  

电子邮件的发送、接收过程可简化为如图6.9所示。  

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/6ca073f4d9e5db6d02912d03369337bbc2dd68d517d1196365f94c02d9453f0b.jpg)  
图6.9电子邮件的发送、接收过程  

下面简单介绍电子邮件的收发过程。  

$\textcircled{\scriptsize{1}}$ 发件人调用用户代理来撰写和编辑要发送的邮件。  

$\circledcirc$ 邮件撰写完后，发件人点击“发送邮件”按钮，把发送邮件的工作全都交给用户代理来完成，就什么都不用管了。用户代理用SMTP把邮件传送给发送端邮件服务器。  

$\textcircled{3}$ 发送端邮件服务器将邮件放入邮件缓存队列中，等待发送。  

$\textcircled{4}$ 发送端邮件服务器的SMTP客户与接收端邮件服务器的SMTP服务器建立TCP连接，然后就把邮件缓存队列中的邮件依次发送出去。注意，邮件是直接传送给接收端邮件服务器的，而不会在互联网的某个中间邮件服务器落地。  

$\circledast$ 运行在接收端邮件服务器中的SMTP服务器进程收到邮件后，将邮件放入收件人的用户邮箱，等待收件人在方便时进行读取。  
$\textcircled{6}$ 收件人打算收信时，调用用户代理，使用POP3（或IMAP）协议将自己的邮件从接收端邮件服务器的用户邮箱中取回（如果邮箱中有来信的话）。  

## 电子邮件格式与MIME  

### 电子邮件格式  

一个电子邮件分为信封和内容两大部分，邮件内容又分为首部和主体两部分。RFC822规定了邮件的首部格式，而邮件的主体部分则让用户自由撰写。用户写好首部后，邮件系统自动地将信封所需的信息提取出来并写在信封上，用户不需要亲自填写信封上的信息。  

邮件内容的首部包含一些首部行，每个首部行由一个关键字后跟冒号再后跟值组成。有些关键字是必需的，有些则是可选的。最重要的关键字是To和Subject。  

To是必填的关键字，后面填入一个或多个收件人的电子邮件地址。电子邮件地址的格式为：收件人邮箱名 $^{\textit{\textregistered}}$ 邮箱所在主机的域名，如abc@cskaoyan.com，abc cska oy an.com这个邮件服务器上必须是唯一的。这也就保证了该邮件地址在整个因特网上是唯一的。  

Subjiect是可选关键字，是邮件的主题，反映了邮件的主要内容。  

当然，还有一个必填的关键字是From，但它通常由邮件系统自动填入。首部与主体之间用一个空行进行分割。典型的邮件内容如下：  

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/ad6c7d88b4818d5ccfd48b3f5f46a9fdfe4b14571fa005e2fce9eb9bd53a5b58.jpg)  

### 多用途因特网邮件扩展（MIME）  

命题追踪SMTP直接传输的内容（2018）  

因为SMTP只能传送7位ASCII码文本邮件，许多其他非英语国家的文字（如中文、俄文，甚至带重音符号的法文或德文）就无法传送，且无法传送可执行文件及其他二进制对象，所以提（Multipurpose Internet Mail Extensions，MIME）。  

MIME并未改动SMTP或取代它。当发送端发送的邮件中包含有非ASCII码数据时，不能直接使用SMTP进行传送，而要通过MIME进行转换，将非ASCII码数据转换为ASCII码数据。之后，就可以使用SMTP进行传送。接收端也要使用MIME对接收到的ASCII码数据进行逆转换，以便可以得到包含有非ASCII码数据的邮件。MIME与SMTP的关系如图6.10所示。  

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/b50f6aad5d70911c62bdd8542a01a0e00833e19a2ac698dac6e472b48a6ca867.jpg)  
图6.10SMTP与MIME的关系  
MIME主要包括以下三部分内容：  

$\textcircled{\scriptsize{1}}$ 5个新的邮件首部字段，包括MIME版本、内容描述、内容标识、传送编码和内容类型。  

$\circledcirc$ 定义了许多邮件内容的格式，对多媒体电子邮件的表示方法进行了标准化。  

$\textcircled{3}$ 定义了传送编码，可对任何内容格式进行转换，而不会被邮件系统改变。  

## SMTP和POP3  

>#### pro：  

1.SMTP  

>#### pro：  

SMTP和POP3在传输层所使用的服务（2015、2018）  

SMTP的用途及特点（2013、2014）  

简单邮件传输协议（Simple Mail Transfer Protocol，SMTP）件传输的协议，它控制两个相互通信的SMTP进程交换信息。因为SMTP采用客户/服务器模式工作，所以负责发送邮件的SMTP进程就是SMTP客户，而负责接收邮件的SMTP进程就是SMTP服务器。SMTP用的是TCP连接，端口号为25。SMTP通信有以下三个阶段。  

#### （1）连接建立  

发件人的邮件发送到发送方邮件服务器的邮件缓存中后，SMTP客户就每隔一定时间对邮件缓存扫描一次。如发现有邮件，就与接收方邮件服务器的SMTP服务器建立TCP连接，SMTP服务器使用的熟知端口号为25。连接建立后，接收方SMTP服务器发出220Serviceready（服务就绪）。然后SMTP客户向SMTP服务器发送HELO命令，附上发送方的主机名。  

SMTP不使用中间的邮件服务器。TCP连接总是在发送方和接收方这两个邮件服务器之间直接建立，而不管它们相隔多远，不管在传送过程中要经过多少个路由器。当接收方邮件服务器因故障暂时不能建立连接时，发送方的邮件服务器只能等待一段时间后再次尝试连接。  

#### （2）邮件传送  

连接建立后，就可开始传送邮件。邮件的传送从MAIL命令开始，MAIL命令后面有发件人的地址。如MAILFROM:<fh@hit.edu.cn>。若SMTP服务器已准备好接收邮件，则回答250OK。下面跟着一个或多个RCPT命令，格式为RCPTTO：<收件人地址>。每发送一个RCPT命令，都应有相应的信息从SMTP服务器返回，如250OK或 $550\,\mathrm{No}$ such user here（无此用户）。  

RCPT命令的作用是，先弄清接收方系统是否已做好接收邮件的准备，然后才发送邮件，以便不至于发送了很长的邮件后才知道地址错误，进而避免浪费通信资源。  

获得OK的回答后，客户端就使用DATA命令，表示要开始传送邮件的内容。正常情况下，SMTP 354 Start mail input;endwith<CRLF>.<CRLF>。<CRLF>表示回车换行。此时SMTP客户就可开始传送邮件内容，并用<CRLF>.<CRLF>表示邮件内容的结束。  

（3）连接释放  

邮件发送完毕后，SMTP客户应发送QUIT命令。SMTP服务器返回的信息是221（服务关闭），表示SMITP同意释放TCP连接。邮件传送的全部过程就此结束。  

2.P0P3和IMAP  

邮局协议（PostOficeProtocol，POP）是一个非常简单但功能有限的邮件读取协议，现在使用的版本是POP3。POP也采用客户/服务器模式，在传输层使用TCP，端口号为110。  

接收方的用户代理必须运行POP客户程序，而接收方的邮件服务器中则运行POP服务器程序。POP有两种工作方式：“下载并保留”和“下载并删除”。在“下载并保留”方式下，用户从邮件服务器上读取邮件后，邮件依然会保存在邮件服务器上，用户可再次从服务器上读取该邮件：  
而使用“下载并删除”方式时，邮件一旦被读取，就被从邮件服务器上删除。  

另一个邮件读取协议是因特网报文存取协议（IMAP），它比POP复杂得多，IMAP为用户提供了创建文件夹、在不同文件夹之间移动邮件及在远程文件夹中查询邮件等联机命令，为此IMAP服务器维护了会话用户的状态信息。IMAP的另一特性是允许用户代理只获取报文的某些部分，例如可以只读取一个报文的首部，或多部分MIM正报文的一部分。这非常适用于低带宽的情况，用户可能并不想取回邮箱中的所有邮件，尤其是包含很多音频或视频的大邮件。  

此外，随着万维网的流行，目前出现了很多基于万维网的电子邮件，如Hotmail、Gmail等。这种电子邮件的特点是，用户浏览器与Hlotmail或Gmail的邮件服务器之间的邮件发送或接收使用的是HTTP，而仅在不同邮件服务器之间传送邮件时才使用SMTP。  
  

二、综合应用题  

01.【解答】  

有时对方的邮件服务器不工作，邮件就发送不出去。对方的邮件服务器出故障也会使邮件去失。有时网络非常拥塞，路由器丢弃大量的IP数据报，导致通信中断。  

02.【解答】  

因为SMTP存在一些缺点和不足，所以通过MIME并非改变或取代SMTP。MIME继续使用RFC822格式，但增加了邮件主体的结构，并定义了传送非ASCII码的编码规则。也就是说，MIME邮件可在已有的电子邮件和协议下传送。  
03.【解答】  

1）本题中并未明确告诉这个报文段是从用户代理发往服务器还是从服务器发往用户代理。分析TCP首部格式可知，源端口为49382（0xc0e6），目的端口为25（0x0019），因此该应用层协议为SMTP。  

2）因为使用的是SMTP，且服务器端口25作为目的端口，所以源端口49382为用户代理所使用的端口。  

3）因为SMTP的协议字段都是用ASCII码表示的，所以发件人的关键字是FROM，从截图AS ClI FROM:cska oy an 2012  $\textit{\textcenttextcenttextcent}$  163.com  

# 万维网 (www)  

## WWW的概念与组成结构  

万维网（WorldWideWeb，WWW）是一个分布式、联机式的信息存储空间，在这个空间中：一样有用的事物称为一样“资源”，并由一个全域“统一资源定位符”（URL）标识。这些资源通过超文本传输协议（HTTP）传送给使用者，而后者通过单击链接来获取资源。  

万维网使用链接的方法能非常方便地从因特网上的一个站点访问另一个站点，从而主动地按需获取丰富的信息。超文本标记语言使得万维网页面的设计者很方便地用一个超链接从本页面的某处链接到因特网上的任何一个页面，并能在自己的计算机屏幕上显示这些页面。  

>#### pro：HTTP在传输层所使用的协议（2018）  

万维网的内核部分是由三个标准构成的：  

1）统一资源定位符（URL）。负责标识万维网上的各种文档，并使每个文档在整个万维网的范围内具有唯一的标识符URL。2）超文本传输协议（HTTP）。一个应用层协议，它使用TCP连接进行可靠的传输，HTTP是万维网客户程序和服务器程序之间交互所必须严格遵守的协议。3）超文本标记语言（HTML）。一种文档结构的标记语言，它使用一些约定的标记对页面上的各种信息（包括文字、声音、图像、视频等）、格式进行描述。URL是对可以从因特网上得到的资源的位置和访问方法的一种简洁表示。URL相当于一个  

文件名在网络范围的扩展。URL的一般形式是：  

<协议>指用什么协议来获取万维网文档，常见的协议有htp、ftp等；<主机>是存放资源的主机在因特网中的域名或IP地址；<端口>和<路径 $\scriptscriptstyle\dot{>}$ 有时可省略。在URL中不区分大小写。  

万维网以客户/服务器模式工作。浏览器是在用户主机上的万维网客户程序，而万维网文档所驻留的主机则运行服务器程序，这台主机称为万维网服务器。客户程序向服务器程序发出请求服务器程序向客户程序送回客户所要的万维网文档。工作流程如下：  

1）Web用户使用浏览器（指定URL）与Web服务器建立连接，并发送浏览请求。  

2）Web服务器把URL转换为文件路径，并返回信息给Web浏览器。  

3）通信完成，关闭连接。  

万维网是无数个网络站点和网页的集合，它们在一起构成了因特网最主要的部分（因特网也包括电子邮件、Usenet和新闻组）。  
## 超文本传输协议（HTTP）  

HTTP定义了浏览器（万维网客户进程）怎样向万维网服务器请求方维网文档，以及服务器怎样把文档传送给浏览器。从层次的角度看，HTTP是面向事务（Transaction-oriented）的应用层协议，它规定了在浏览器和服务器之间的请求和响应的格式与规则，是方维网上能够可靠地交换文件（包括文本、声音、图像等各种多媒体文件）的重要基础。  

### HTTP的操作过程  

从协议执行过程来说，浏览器要访问WWW服务器时，首先要完成对WWW服务器的域名解析。一旦获得了服务器的IP地址，浏览器就通过TCP向服务器发送连接建立请求。  

万维网的大致工作过程如图6.11所示。  

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/363a6b1080e3e78e9e80684b408b2662a0e895391584428207a067d33fa28931.jpg)  
图6.11万维网的工作过程  

每个方维网站点都有一个服务器进程，它不断地监听TCP的端口80（默认），当监听到连接请求后便与浏览器建立TCP连接。然后，浏览器就向服务器发送请求获取某个Web页面的HTTP请求。服务器收到请求后，将构建所请求W6页的必需信息，并通过HTTP响应返回给浏览器。浏览器再将信息进行解释，然后将Web页显示给用户。最后，TCP连接释放。  

>#### pro：访问Web时可能用到的协议（2014、2021）  

用户单击鼠标后所发生的事件按顺序如下（以访问清华大学的网站为例）：  

1）URL（http://www.tsinghua.edu.cn/chn/index.htm）。2）DNS www.tsinghua.edu.cn的IP地址。3）域名系统DNS解析出清华大学服务器的IP地址。4）浏览器与该服务器建立TCP连接（默认端口号为80）。5）HTTP：GET/chn/index.htm 6）服务器通过HTTP响应把文件index.htm发送给浏览器。  

7）释放TCP连接。  

8）浏览器解释文件index.htm，并将Web页显示给用户。  

上述过程是一个简化过程，实际过程涉及TCP/IP体系结构中应用层的DHCP、DNS和HTTP，传输层的UDP和TCP，网际层的IP和ARP，数据链路层的CSMA/CD或PPP（若涉及ISP接入或广域网传输）。本节主要介绍HTTP。  
2.HTTP的特点  

HTTP使用TCP作为传输层协议，保证了数据的可靠传输。HTTP不必考虑数据在传输过程中被丢弃后又怎样被重传。但是，HTTP本身是无连接的（务必注意）。也就是说，虽然HTTP使用了TCP连接，但通信的双方在交换HTTP报文之前不需要先建立HTTP连接。  

HTTP是无状态的。也就是说，同一个客户第二次访问同一个服务器上的页面时，服务器的响应与第一次被访问时的相同，因为服务器并不记得曾经服务过的这个客户。  

HTTP的无状态特性简化了服务器的设计，使之更易支持大量并发的请求。在实际应用中，通常使用Cookie加数据库的方式来跟踪用户的活动（如记录用户最近浏览的商品等）。Cookie的工作原理：当用户初次浏览某个使用Cookie的网站时，该网站服务器就为用户产生一个唯一的Cookie识别码，如“12345”，并以此为索引在后端数据库中创建一个项目，用来记录用户访问该网站的各种信息。接着在给用户的响应报文中添加一个Set-cookie的首部行“Setcookie:12345”，用户收到响应后，就在它管理的特定Cookie文件中添加该服务器的主机名和Cookie识别码。当用户再次浏览这个网站时，会取出这个网站的识别码，并在请求报文中添加一个Cookie首部行“Cookie:12345”。服务器根据Cookie识别码就能从数据库中查询到该用户的活动记录，进而执行一些个性化的工作，如根据用户的历史浏览记录向其推荐新商品等。  

HTTP既可以使用非持续连接（HTTP/1.O），也可以使用持续连接（HTTP/1.1支持）。  

>#### pro：HTTP页面请求时间的分析（2020）  

对于非持续连接，每个网页元素对象（如JPEG图形、Flash等）的传输都需要单独建立一个TCP连接，如图6.12所示（第三次握手的报文段中梢带了客户对万维网文档的请求）。请求一个万维网文档所需的时间是该文档的传输时间（与文档大小成正比）加上两倍往返时间RTT（一个RTT用于TCP连接，另一个RTT用于请求和接收文档）。每请求一个对象都导致 $2{\times}\mathrm{RTT}$ 的开销，此外每次建立新的TCP连接都要分配缓存和变量，使万维网服务器的负担很重。  

所谓持续连接，是指万维网服务器在发送响应后仍然保持这条连接，使同一个客户和该服务器可以继续在这条TCP连接上传送后续的HTTP请求报文和响应报文，如图6.13所示。  

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/08b82f7f1d88b1f3b0c9eb1da958e256c83631e22d81d9985f204e369daec97d.jpg)  
图6.12请求一个万维网文档所需的时间  

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/d8a1e5c5841bd5690047250af1122856a1bed175683d0f7181aa958511f8ee4e.jpg)  
图6.13使用持续连接（非流水线）  
>#### pro：HTTP/1.1页面请求时间的分析（2011、2022）  

HTTP/1.1默认使用持续连接。持续连接又分为非流水线和流水线两种工作方式。对于非流水线方式，客户在收到前一个响应后才能发出下一个请求，服务器在发送完一个对象后，其TCP连接就处于空闲状态，浪费了服务器资源。对于流水线方式，客户可以连续发出对各个对象的请求，服务器就可连续响应这些请求。若所有的请求和响应都是连续发送的，则引用所有对象共计经历1个RTT延迟，而不是像非流水线方式那样，每个对象都必须有1个RTT延迟。这种方式减少了TCP连接中的空闲时间，提高了效率。当然，在流水线方式中，服务器在每个RTT连续发送的数据量还受到TCP发送窗口的限制。  

### HTTP的报文结构  

>#### pro：  HTTP请求报文中各种方法的意义（2015）  

HTTP是面向文本的（Text-Oriented），因此报文中的每个字段都是一些ASCⅡI码串，并且每个字段的长度都是不确定的。有两类HTTP报文：  

请求报文：从客户向服务器发送的请求报文，如图6.14(a)所示。响应报文：从服务器到客户的回答，如图6.14(b)所示。  

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/dc22417e8a5262e7d4371c0540322afc2b85b46a41a3f4dc747d385dd38e9c24.jpg)  
图6.14HTTP的报文结构  

从图6.14可以看出，两种报文都由三个部分组成，两者格式的区别就是开始行不同。  

开始行：在请求报文中的开始行称为请求行，而在响应报文中的开始行称为状态行。开始行的三个字段之间都以空格分隔，最后的“CR”和“LF”分别代表“回车”和“换行”。  

首部行：用来说明浏览器、服务器或报文主体的一些信息。首部可以有几行，但也可以不使用。在每个首部行中都有首部字段名和它的值，每一行的结束都要有“回车”和“换行”。整个首部行结束时，还有一空行将首部行和后面的实体主体分开。  

实体主体：在请求报文中一般不用这个字段，而在响应报文中也可能没有这个字段。  

请求报文的“请求行”有三个内容：方法、请求资源的URL及HTTP的版本。其中，“方法”是对所请求对象进行的操作，这些方法实际上也就是一些命令。表6.1列出了常用的几种方法。  

表6.1HTTP请求报文中常用的几个方法
![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/92d53ee3242092e4b08f0650c3127b1480828e42ece80aeb9314973ae11db4ab.jpg)  
下面是一个典型的HTTP请求报文：  

GET/bbs/index.htmHTTP/1.1指明方法“GET”、相对URL、HTTP版本}Host:www.cskaoyan.com 指明服务器的域名 Connection: Keep-Alive要求服务器在发送完被请求的文档后保持这条连接User-Agent:Mozilla/5.0{表明用户代理是浏览器Mozilla/5.0}Accept-Language: cn{表示用户希望优先得到中文版本的文档}  

第1行是请求行，它使用了相对URL，因为下面的首部行给出了服务器的域名。第3行告诉服务器使用持续连接，表示浏览器要求服务器在发送完被请求的文档后保持这条TCP连接，若要求使用非持续连接，则对应首部行应为“Connection:close”。  

HTTP响应报文的第1行是状态行，它包含三个内容：HTTP的版本、状态码、解释状态码的短语。下面是HTTP响应报文中常见的三种状态行：  

HTTP/1.1 202 Accepted{接受请求}HTTP/1.1 400Bad Request {错误的请求} HTTP/1.1404 Not Found{找不到页面}  

### HTTP请求报文举例  

图6.15所示为Wireshark捕获的一个HTTP请求报文。  

![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/515e751b14db49afc2fe22d36d3a943c3fb0480756f37eda47cc30973bd9d976.jpg)  
图6.15用Wireshark捕获的一个HTTP请求报文  

根据帧的结构定义，在图6.15的以太网数据帧中，第 $1\!\sim\!6$ 个字节为目的MAC地址（默认网关地址），即00-0f-e2-3f-27-3f；第 $7\!\sim\!12$ 个字节为本机MAC地址，即00-27-13-67-73-8d；第 $13\!\sim\!14$ 个字节 $08\!\sim\!00$ 为类型字段，表示上层使用的是IP数据报协议。第 $15{\sim}34$ 个字节（共20B）为IP数据报的首部，其中第 $27\!\sim\!30$ 个字节为源IP地址，即db-df-d2-70，转换成十进制为219.223.210.112：第 $31\!\sim\!34$ 个字节为目的IP地址，即71-69-4e-0a，转换成十进制为113.105.78.10。第 $35\!\sim\!54$ 个字节（共20B）为TCP报文段的首部。  

从第55个字节开始才是TCP数据部分（阴影部分），即从应用层传递下来的数据（本例中即请求报文），GET对应请求行的方法，/face/20.gif对应请求行的URL， $\mathrm{HTTP}/1.1$ 对应请求行的版本，左边数字是对应字符的ASCII码，如 $\mathrm{'G'}\,{=}\,0\mathrm{x}47$ 、 ${}^{\prime}\mathrm{E^{\prime}}\!=\!0\mathrm{x}45$ 、 $\mathrm{{'T'}}\!=\!0\mathrm{{x}}54$ 等。图6.15的请求报文中首部行字段内容的含义，建议读者自行了解，也可以自己动手抓包分析。  
常见应用层协议小结如表6.2所示。  

表6.2常见应用层协议小结
![](https://cdn-mineru.openxlab.org.cn/model-mineru/prod/6a17e3acc5e24d05afd103b899739bb177a17668a96e0a1d020cb0a76d5289c1.jpg)  


# 本章小结及疑难点  

1.如何理解客户进程端口号与服务器进程端口号？  

通常我们所说的熟知端口号是指应用层协议在服务器端的默认端口号，而客户端进程的端口号是由客户端进程任意指定的（临时的）。  

当客户进程向服务器进程发出建立连接请求时，要寻找连接服务器进程的熟知端口号，同时还要告诉服务器进程自己的临时端口号。接着，服务器进程就用自己的熟知端口号与客户进程所提供的端口号建立连接。  

2.因特网和万维网的区别是什么？  

因特网（Intemet）是指在ARPA网基础上发展而来的世界上最大的全球性互连网络，它采用TCP/IP协议族作为通信规则。  

万维网（WWW）是无数个网络站点和网页的集合，它们一起构成了因特网最主要的部分（因特网也包括电子邮件、Usenet和新闻组）。  